{% extends "trelix_app/base.html" %}
{% load static %}
{% block title %}Mes Préférences - Trelix{% endblock %}
{% block content %}
{% include 'trelix_app/header.html' %}

<section class="promo-sec position-relative overflow-hidden"
 style="background: linear-gradient(135deg, rgba(99,102,241,.95) 0%, rgba(139,92,246,.95) 100%); padding:60px 0;">
  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <h1 class="display-4 text-white fw-bold mb-3">
          <i class="feather-icon icon-settings"></i> Mes Préférences
        </h1>
        <p class="text-white-50 fs-5 mb-4">
          Gérez vos préférences d'apprentissage
        </p>
      </div>
    </div>
  </div>
</section>

<section class="py-5 bg-light">
  <div class="container">
    <div class="row mb-4">
      <div class="col-lg-8">
        <h2 class="display-6 fw-bold text-dark mb-3">Vos Préférences</h2>
        <p class="text-muted fs-5">Configurez vos préférences pour personnaliser votre expérience</p>
      </div>
      <div class="col-lg-4 text-lg-end">
        <a href="{% url 'preference:preference_create' %}" class="btn btn-primary btn-lg rounded-pill px-4">
          <i class="feather-icon icon-plus me-2"></i>Nouvelle Préférence
        </a>
      </div>
    </div>

    <!-- Filtrage et Recherche -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <div class="row g-3 align-items-end">
              <!-- Barre de recherche -->
              <div class="col-lg-4 col-md-6">
                <label class="form-label fw-semibold text-muted mb-2">
                  <i class="feather-icon icon-search me-1"></i>Rechercher
                </label>
                <div class="input-group">
                  <input type="text" class="form-control" id="searchInput" placeholder="Rechercher dans les préférences...">
                  <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                    <i class="feather-icon icon-x"></i>
                  </button>
                </div>
              </div>

              <!-- Filtre par langue -->
              <div class="col-lg-3 col-md-6">
                <label class="form-label fw-semibold text-muted mb-2">
                  <i class="feather-icon icon-globe me-1"></i>Langue
                </label>
                <select class="form-select" id="langueFilter">
                  <option value="">Toutes les langues</option>
                  <option value="Français">Français</option>
                  <option value="Anglais">Anglais</option>
                </select>
              </div>

              <!-- Filtre par format -->
              <div class="col-lg-3 col-md-6">
                <label class="form-label fw-semibold text-muted mb-2">
                  <i class="feather-icon icon-book me-1"></i>Format
                </label>
                <select class="form-select" id="formatFilter">
                  <option value="">Tous les formats</option>
                  <option value="PDF">PDF</option>
                  <option value="Vidéo">Vidéo</option>
                  <option value="Quiz">Quiz</option>
                  <option value="Interactif">Interactif</option>
                </select>
              </div>

              <!-- Filtre par mode d'étude -->
              <div class="col-lg-2 col-md-6">
                <label class="form-label fw-semibold text-muted mb-2">
                  <i class="feather-icon icon-users me-1"></i>Mode
                </label>
                <select class="form-select" id="modeFilter">
                  <option value="">Tous les modes</option>
                  <option value="Individuel">Individuel</option>
                  <option value="Groupe">Groupe</option>
                </select>
              </div>

              <!-- Filtres avancés -->
              <div class="col-12 mt-3" id="advancedFilters" style="display: none;">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label fw-semibold text-muted mb-2">
                      <i class="feather-icon icon-clock me-1"></i>Période
                    </label>
                    <select class="form-select" id="periodeFilter">
                      <option value="">Toutes périodes</option>
                      <option value="Jour">Jour</option>
                      <option value="Nuit">Nuit</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-semibold text-muted mb-2">
                      <i class="feather-icon icon-sun me-1"></i>Vacances
                    </label>
                    <select class="form-select" id="vacancesFilter">
                      <option value="">Toutes options</option>
                      <option value="Oui">Oui</option>
                      <option value="Non">Non</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-semibold text-muted mb-2">
                      <i class="feather-icon icon-filter me-1"></i>Trier par
                    </label>
                    <select class="form-select" id="sortFilter">
                      <option value="default">Ordre par défaut</option>
                      <option value="langue-asc">Langue A-Z</option>
                      <option value="langue-desc">Langue Z-A</option>
                      <option value="format-asc">Format A-Z</option>
                      <option value="format-desc">Format Z-A</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Actions des filtres -->
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" id="toggleFilters">
                      <i class="feather-icon icon-filter me-1"></i>
                      Filtres avancés
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="resetFilters">
                      <i class="feather-icon icon-refresh-cw me-1"></i>
                      Réinitialiser
                    </button>
                  </div>
                  <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-primary" id="activeFiltersCount">0</span>
                    <span class="text-muted small" id="filterSummary">{{ preferences|length }} préférence(s)</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Liste des préférences -->
    <div class="row" id="preferencesContainer">
      {% for pref in preferences %}
      <div class="col-lg-6 mb-4 preference-item" 
           data-langue="{{ pref.langue }}"
           data-format="{{ pref.formatCours }}"
           data-mode="{{ pref.modeEtude }}"
           data-periode="{{ pref.periode }}"
           data-vacances="{{ pref.vacances }}"
           data-search="{{ pref.langue }} {{ pref.formatCours }} {{ pref.modeEtude }} {{ pref.periode }} {{ pref.vacances }}">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0 text-primary">
                <i class="feather-icon icon-user me-2"></i>
                Préférence {{ forloop.counter }}
              </h5>
              <span class="badge bg-light text-dark">
                <i class="feather-icon icon-{% if pref.langue == 'Français' %}flag{% else %}globe{% endif %} me-1"></i>
                {{ pref.langue }}
              </span>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <i class="feather-icon icon-book text-primary me-2"></i>
                  <div>
                    <small class="text-muted d-block">Format</small>
                    <strong>{{ pref.formatCours }}</strong>
                  </div>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <i class="feather-icon icon-users text-primary me-2"></i>
                  <div>
                    <small class="text-muted d-block">Mode</small>
                    <strong>{{ pref.modeEtude|default:"Non spécifié" }}</strong>
                  </div>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <i class="feather-icon icon-clock text-primary me-2"></i>
                  <div>
                    <small class="text-muted d-block">Période</small>
                    <strong>{{ pref.periode|default:"Non spécifié" }}</strong>
                  </div>
                </div>
              </div>
              <div class="col-6 mb-3">
                <div class="d-flex align-items-center">
                  <i class="feather-icon icon-sun text-primary me-2"></i>
                  <div>
                    <small class="text-muted d-block">Vacances</small>
                    <strong>{{ pref.vacances|default:"Non spécifié" }}</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer bg-white border-0 pt-0">
            <div class="d-flex gap-2">
              <a href="{% url 'preference:preference_update' %}?uri={{ pref.uri|urlencode }}" 
                 class="btn btn-outline-primary btn-sm flex-fill">
                <i class="feather-icon icon-edit me-1"></i>Modifier
              </a>
              <a href="{% url 'preference:preference_delete' %}?uri={{ pref.uri|urlencode }}" 
                 class="btn btn-outline-danger btn-sm flex-fill"
                 onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette préférence ?')">
                <i class="feather-icon icon-trash me-1"></i>Supprimer
              </a>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="text-center py-5" id="emptyState">
          <div class="empty-state-icon mb-4">
            <i class="feather-icon icon-settings display-1 text-muted"></i>
          </div>
          <h3 class="text-muted mb-3">Aucune préférence configurée</h3>
          <p class="text-muted mb-4">Créez votre première préférence pour personnaliser votre expérience.</p>
          <a href="{% url 'preference:preference_create' %}" class="btn btn-primary btn-lg rounded-pill">
            <i class="feather-icon icon-plus me-2"></i>Créer une préférence
          </a>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- État vide après filtrage -->
    <div class="row d-none" id="noResultsState">
      <div class="col-12">
        <div class="text-center py-5">
          <div class="empty-state-icon mb-4">
            <i class="feather-icon icon-search display-1 text-muted"></i>
          </div>
          <h3 class="text-muted mb-3">Aucune préférence trouvée</h3>
          <p class="text-muted mb-4">Aucune préférence ne correspond à vos critères de recherche.</p>
          <button class="btn btn-outline-primary" id="resetSearch">
            <i class="feather-icon icon-refresh-cw me-2"></i>
            Réinitialiser la recherche
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
/* Styles pour les cartes de préférences */
.preference-item {
    transition: all 0.3s ease;
}

.preference-item:hover {
    transform: translateY(-5px);
}

.card {
    border-radius: 12px;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

/* Styles pour les filtres */
.form-select:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

#advancedFilters {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Badge pour le compteur de filtres */
#activeFiltersCount {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Animation pour les éléments filtrés */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.preference-item {
    animation: fadeIn 0.5s ease forwards;
}

.preference-item:nth-child(1) { animation-delay: 0.05s; }
.preference-item:nth-child(2) { animation-delay: 0.1s; }
.preference-item:nth-child(3) { animation-delay: 0.15s; }
.preference-item:nth-child(4) { animation-delay: 0.2s; }

/* Responsive */
@media (max-width: 768px) {
    .card-footer .d-flex.gap-2 {
        flex-direction: column;
    }
    
    .card-footer .btn {
        margin-bottom: 5px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments DOM
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const langueFilter = document.getElementById('langueFilter');
    const formatFilter = document.getElementById('formatFilter');
    const modeFilter = document.getElementById('modeFilter');
    const periodeFilter = document.getElementById('periodeFilter');
    const vacancesFilter = document.getElementById('vacancesFilter');
    const sortFilter = document.getElementById('sortFilter');
    const toggleFilters = document.getElementById('toggleFilters');
    const resetFilters = document.getElementById('resetFilters');
    const advancedFilters = document.getElementById('advancedFilters');
    const activeFiltersCount = document.getElementById('activeFiltersCount');
    const filterSummary = document.getElementById('filterSummary');
    const preferencesContainer = document.getElementById('preferencesContainer');
    const noResultsState = document.getElementById('noResultsState');
    const emptyState = document.getElementById('emptyState');
    const resetSearch = document.getElementById('resetSearch');

    const preferenceItems = document.querySelectorAll('.preference-item');

    // État des filtres
    let filters = {
        search: '',
        langue: '',
        format: '',
        mode: '',
        periode: '',
        vacances: '',
        sort: 'default'
    };

    // Appliquer les filtres
    function applyFilters() {
        let visibleItems = Array.from(preferenceItems);
        let activeFilterCount = 0;

        // Filtre de recherche
        if (filters.search) {
            visibleItems = visibleItems.filter(item => {
                const searchText = item.dataset.search.toLowerCase();
                return searchText.includes(filters.search.toLowerCase());
            });
            activeFilterCount++;
        }

        // Filtre par langue
        if (filters.langue) {
            visibleItems = visibleItems.filter(item => 
                item.dataset.langue === filters.langue
            );
            activeFilterCount++;
        }

        // Filtre par format
        if (filters.format) {
            visibleItems = visibleItems.filter(item => 
                item.dataset.format === filters.format
            );
            activeFilterCount++;
        }

        // Filtre par mode
        if (filters.mode) {
            visibleItems = visibleItems.filter(item => 
                item.dataset.mode === filters.mode
            );
            activeFilterCount++;
        }

        // Filtre par période
        if (filters.periode) {
            visibleItems = visibleItems.filter(item => 
                item.dataset.periode === filters.periode
            );
            activeFilterCount++;
        }

        // Filtre par vacances
        if (filters.vacances) {
            visibleItems = visibleItems.filter(item => 
                item.dataset.vacances === filters.vacances
            );
            activeFilterCount++;
        }

        // Tri
        if (filters.sort !== 'default') {
            visibleItems.sort((a, b) => {
                const aValue = a.dataset[filters.sort.split('-')[0]];
                const bValue = b.dataset[filters.sort.split('-')[0]];
                
                if (filters.sort.includes('asc')) {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
        }

        // Mise à jour de l'UI
        updateUI(visibleItems, activeFilterCount);
    }

    // Mettre à jour l'interface
    function updateUI(visibleItems, activeFilterCount) {
        // Masquer/afficher les éléments
        preferenceItems.forEach(item => {
            if (visibleItems.includes(item)) {
                item.style.display = '';
                item.style.animation = 'fadeIn 0.5s ease';
            } else {
                item.style.display = 'none';
            }
        });

        // Mettre à jour les compteurs
        activeFiltersCount.textContent = activeFilterCount;
        filterSummary.textContent = `${visibleItems.length} préférence(s)`;

        // Gérer les états vides
        if (visibleItems.length === 0) {
            preferencesContainer.classList.add('d-none');
            noResultsState.classList.remove('d-none');
            if (emptyState) emptyState.classList.add('d-none');
        } else {
            preferencesContainer.classList.remove('d-none');
            noResultsState.classList.add('d-none');
            if (emptyState) emptyState.classList.add('d-none');
        }

        // Afficher/masquer le compteur de filtres
        if (activeFilterCount > 0) {
            activeFiltersCount.style.display = 'inline-block';
        } else {
            activeFiltersCount.style.display = 'none';
        }
    }

    // Événements
    searchInput.addEventListener('input', function() {
        filters.search = this.value;
        applyFilters();
    });

    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        filters.search = '';
        applyFilters();
    });

    langueFilter.addEventListener('change', function() {
        filters.langue = this.value;
        applyFilters();
    });

    formatFilter.addEventListener('change', function() {
        filters.format = this.value;
        applyFilters();
    });

    modeFilter.addEventListener('change', function() {
        filters.mode = this.value;
        applyFilters();
    });

    periodeFilter.addEventListener('change', function() {
        filters.periode = this.value;
        applyFilters();
    });

    vacancesFilter.addEventListener('change', function() {
        filters.vacances = this.value;
        applyFilters();
    });

    sortFilter.addEventListener('change', function() {
        filters.sort = this.value;
        applyFilters();
    });

    toggleFilters.addEventListener('click', function() {
        if (advancedFilters.style.display === 'none') {
            advancedFilters.style.display = 'block';
            this.innerHTML = '<i class="feather-icon icon-filter me-1"></i>Masquer les filtres';
        } else {
            advancedFilters.style.display = 'none';
            this.innerHTML = '<i class="feather-icon icon-filter me-1"></i>Filtres avancés';
        }
    });

    resetFilters.addEventListener('click', function() {
        // Réinitialiser tous les filtres
        searchInput.value = '';
        langueFilter.value = '';
        formatFilter.value = '';
        modeFilter.value = '';
        periodeFilter.value = '';
        vacancesFilter.value = '';
        sortFilter.value = 'default';
        
        filters = {
            search: '',
            langue: '',
            format: '',
            mode: '',
            periode: '',
            vacances: '',
            sort: 'default'
        };
        
        applyFilters();
    });

    resetSearch.addEventListener('click', function() {
        resetFilters.click();
    });

    // Initialiser l'interface
    applyFilters();
});
</script>

{% include 'trelix_app/footer.html' %}
{% endblock %}